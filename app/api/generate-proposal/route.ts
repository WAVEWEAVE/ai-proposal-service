/**
 * 제안서 생성 API - 최소 버전
 * Anthropic Claude를 사용하여 AI 제안서 생성
 */

import { anthropic } from '@ai-sdk/anthropic';
import { streamText } from 'ai';

export const runtime = 'edge';

/**
 * POST /api/generate-proposal
 * 17개 질문 답변을 받아 제안서 생성
 */
export async function POST(req: Request) {
  try {
    // API 키 확인
    if (!process.env.ANTHROPIC_API_KEY) {
      console.error('[API 키 오류] ANTHROPIC_API_KEY가 설정되지 않았습니다.');
      return new Response(
        JSON.stringify({
          error: 'API 키가 설정되지 않았습니다.',
          details: '.env.local 파일에 ANTHROPIC_API_KEY를 설정해주세요.',
        }),
        {
          status: 500,
          headers: { 'Content-Type': 'application/json' },
        }
      );
    }

    const { answers, quickStart } = await req.json();

    console.log('[제안서 생성 API 시작 - 최소 버전]', { 
      answersCount: Object.keys(answers || {}).length, 
      quickStart,
      hasApiKey: !!process.env.ANTHROPIC_API_KEY 
    });

    // 스토리텔링 + 구조화 밸런스형 프롬프트
    const prompt = `당신은 15년 차 시니어 비즈니스 전략 기획자이자 스토리텔링 전문가입니다.

## 핵심 원칙
- 존중과 정중함: 고객에게 제안하는 입장, 명령/단정 어조 금지
- 읽는 사람 입장에서: 스토리로 공감하고, 구조화된 정보로 빠르게 스캔 가능하게
- 이모지 절대 사용 금지
- 기술 용어 최소화 (API, 데이터베이스 같은 단어 금지)
- "설명 먼저 → 구조화 요약" 패턴 필수
- 테이블이나 리스트를 갑자기 던지지 말고, 항상 맥락 설명 후 제시
- 도입부 필수: 정중한 인사와 제안 배경부터 시작

## 제안서 정보

**전문분야**: ${quickStart?.expertise || '미입력'}
**타겟 고객**: ${quickStart?.industry || '미입력'}

**고객 정보**:
- 고객사/담당자: ${answers.q1 || ''}
- 현재 상황: ${answers.q2 || ''}
- 미해결 시 리스크: ${answers.q3 || ''}

**제안 내용**:
- 서비스: ${answers.q4 || ''}
- 프로세스: ${answers.q5 || ''}
- 기간: ${answers.q6 || ''}

**전문성**:
- 강점: ${answers.q7 || ''}
- 경험: ${answers.q8 || ''}
- 후기: ${answers.q9 || ''}

**스토리**:
- 시작 배경: ${answers.q10 || ''}
- 극복 도전: ${answers.q11 || ''}
- 비전: ${answers.q12 || ''}

**기대 효과**:
- 변화: ${answers.q13 || ''}
- 성과: ${answers.q14 || ''}

**조건**:
- 가격: ${answers.q15 || ''}
- 협의사항: ${answers.q16 || ''}
- 연락처: ${answers.q17 || ''}

---

## 제안서 구조 (8부작)

### 0부: 도입부 (10%, 필수)

**목적**: 정중한 인사와 제안 배경, 제안서 목적

**필수 요소**:
1. 정중한 인사 ("[고객명]님께, 안녕하십니까")
2. 간단한 자기소개 또는 제안 계기
3. 제안서 목적과 핵심 가치 (1-2문장)
4. 본문 시작 연결

**톤**: 정중하고 예의 바름, 존중감

예시:
"[고객명]님께,

안녕하십니까. [서비스/솔루션]에 대해 제안드리고자 연락드렸습니다.

[고객 업종/업무]에서 가장 중요한 것은 [핵심 가치]입니다. 하지만 [문제 상황]으로 인해 본연의 업무에 집중하기 어려운 경우가 많습니다.

이번 제안서는 [고객명]님과 팀이 [목표]에 집중할 수 있도록, [솔루션]을 담았습니다."

**절대 금지**: "~하시죠?", "~없으신가요?" 같은 반말/질문형

---

### 1부: 현황 분석 (15%, 순수 스토리)

**제목 예시**: "## 현재 상황에 대한 이해" 또는 "## 업무 환경 분석"

**내용**: 고객이 현재 겪는 어려움을 구체적으로 묘사.
"매일 밤 늦게까지...", "실수 한 번이면..." 같은 생생한 표현.
2-3문단, 공감하는 톤.

**톤**: "~할 수 있습니다", "~것으로 보입니다" (정중한 서술)

**절대 금지**: "~하시죠?", "혹시 이런 적 없으신가요?" 같은 반말

---

### 2부: 현황 진단 (15%, 설명 → 요약 패턴)

**제목 예시**: "## 현황 진단" 또는 "## 상황 분석"

**필수 패턴**:
1. 먼저 2-3문단으로 현재 상황을 스토리로 설명
2. 그 다음 "정리하면 이렇습니다" 같은 자연스러운 연결
3. 간단한 요약 박스 제시

예시:
"지금 [고객명]님 팀이 겪고 있는 상황을 정리해봤습니다. 하루에 주문 정리하는 데만 평균 5시간이 걸리고 있고, 그 과정에서 한 달에 크고 작은 실수가 10건 정도 발생합니다. 계산해보니 이 비효율로 인한 손실이 만만치 않더군요.

**현재 상황 요약**

하루 수작업 시간: 5시간
월 주문 오류: 평균 10건
직원 초과 근무: 주당 10시간
월 예상 손실: 약 500만원

만약 이 상황이 1년, 2년 계속된다면..."

---

### 3부: 제안 솔루션 (20%, 스토리 → 핵심 변화)

**제목 예시**: "## 제안 솔루션" 또는 "## 개선 방안"

**필수 패턴**:
1. Before 상황을 스토리로 (2-3문단)
2. After 상황을 스토리로 (2-3문단)
3. "정리하면 이런 변화가 생깁니다" 같은 연결
4. 핵심 변화 불릿 포인트

예시:
"제가 제안하는 건 단순합니다. 이제 [고객명]님은 새벽에 일어나지 않아도 됩니다. 고객이 밤 11시에 주문하든, 새벽 3시에 주문하든 상관없이 시스템이 자동으로 정리합니다...

**핵심 변화**

주문 처리: 5시간 → 30분 (90% 단축)
주문 정확도: 오류 제로
직원 근무: 정시 퇴근 가능
월 비용 절감: 약 300만원

그렇다고 해서 직원을 줄이자는 얘기가 아닙니다..."

**중요**: 절대 갑자기 리스트를 던지지 말 것. 항상 스토리로 설명 → 요약 순서.

**톤**: "~할 수 있습니다", "~됩니다" (정중한 서술)

**절대 금지**: "이렇게 바뀝니다", "됩니다!" 같은 단정/명령 어조

---

### 4부: 추진 방안 (15%, 프로세스 설명 → 타임라인)

**제목 예시**: "## 추진 방안" 또는 "## 프로젝트 진행 계획"

**필수 패턴**:
1. 전체 기간과 접근 방식 설명 (2-3문단)
2. "구체적으로 말씀드리면" 같은 연결
3. 간단한 타임라인

예시:
"프로젝트는 약 3개월 정도 잡고 있습니다. 처음 1-2주는 [고객명]님과 자주 만나게 될 겁니다. 현재 업무 프로세스를 세세하게 파악하고...

**프로젝트 일정**

Week 1-2: 요구사항 분석 및 기획
Week 3-5: UI/UX 디자인
Week 6-10: 개발 및 연동
Week 11-12: 테스트 및 배포

급하게 만들어서 나중에 문제 생기는 것보다..."

---

### 5부: 적용 사례 (15%, 사례 스토리 → 성과 요약)

**제목 예시**: "## 적용 사례" 또는 "## 유사 프로젝트 성과"

**필수 패턴**:
1. 실제 프로젝트 사례를 스토리로 (2-3문단)
2. "실제 수치로 보면" 같은 연결
3. 성과 요약

예시:
"작년에 프레시밀이라는 신선식품 배송 업체를 도와드린 적이 있습니다. 처음 미팅 때 대표님이 하시던 말씀이 지금 [고객명]님과 똑같았습니다...

**프레시밀 성과**

주문 처리: 5시간 → 1시간 (80% 단축)
월 매출: 2,000만원 → 5,000만원
고객 만족도: 대폭 상승

또 다른 곳은 오가닉마켓이라는..."

여러 사례가 있으면 각각 스토리 → 성과 패턴 반복.

---

### 6부: 투자 계획 (10%, 설명 → ROI)

**제목 예시**: "## 투자 계획" 또는 "## 제안 조건"

**필수 패턴**:
1. 투자 금액의 의미를 먼저 설명 (1-2문단)
2. "구체적으로 계산하면" 같은 연결
3. 투자 및 ROI 요약

예시:
"투자 금액은 1,500만원입니다. 솔직히 작은 돈은 아닙니다. 하지만 계산해보면 월 300만원 정도 비용이 절감되니까...

**투자 및 효과**

초기 투자: 1,500만원
월 절감액: 약 300만원
투자 회수: 5개월

**1년 후 누적 효과**

총 절감액: 3,600만원
순이익: +2,100만원

더 중요한 건 돈보다..."

---

### 7부: 맺음말 (5%, 정중한 마무리)

**제목 예시**: "## 맺음말" 또는 "## 제안 드리며"

**내용**: 연락 방법, 협의 가능성, 정중한 마무리.

**톤**: 정중하고 진심 어린, 존중감

예시:
"[고객명]님께서 본연의 업무에만 집중하실 수 있도록, 저희가 최선을 다해 지원하겠습니다.

더 자세한 논의가 필요하시면 언제든 연락 주시기 바랍니다.

**연락 방법**

전화: ${answers.q17 || '010-XXXX-XXXX'}
이메일: dev@example.com

좋은 기회로 함께할 수 있기를 기대하겠습니다."

**절대 금지**: "만나서 이야기하시죠", "연락 주세요" 같은 명령형

---

## 문체 규칙

**해야 할 것**:
- 존중과 정중함: "~할 수 있습니다", "~것으로 보입니다", "~기대합니다"
- 제안하는 입장: "제안드립니다", "생각합니다"
- 대화하듯 자연스럽게 ("~더군요", "~하더라고요") - 단, 과도하지 않게
- 고객 이름 직접 호명 ("당신", "귀사" 금지)
- 구체적 숫자 (약 50% ❌, 53% ✅)
- 짧은 문장과 중간 문장 섞어 리듬감

**하지 말아야 할 것**:
- 이모지
- 반말/명령형: "~하시죠?", "~없으신가요?", "연락 주세요" 금지
- 단정/건방진 어조: "이렇게 바뀝니다", "~하겠습니다(가르치는 뉘앙스)"
- 갑자기 리스트/테이블 던지기 (항상 설명 먼저)
- "~이며, ~하며" 같은 개조식
- 기술 용어 (API, DB, 프레임워크 등)
- 과장 ("최고", "완벽" 등)

---

## 마크다운 사용

**제목 스타일 (중요)**:
- 대제목 (## 제목): 정중하고 간결하게 (5-7자)
  - 좋은 예: "## 현황 분석", "## 제안 솔루션", "## 맺음말"
  - 나쁜 예: "## 지금 상황, 정확히 짚어보겠습니다", "## 이렇게 바뀝니다"
- 소제목 (### 소제목): 가격 플랜, 프로젝트명 등에만 사용
- 강조: **중요 숫자나 핵심 단어만** (한 문장에 3개 이하)
- 리스트: 간결한 항목만 (긴 설명은 문단으로)

---

## 절대 규칙

1. **도입부 필수**: 정중한 인사, 제안 배경, 목적부터 시작
2. **제목은 정중하게**: 5-7자 내외, 간결, 존중감 ("~바뀝니다" ❌)
3. **반말/명령형 금지**: "~하시죠?", "연락 주세요" 사용 금지
4. **설명 → 요약 순서**: 리스트/테이블 전에 반드시 맥락 설명
5. **스토리 60% + 구조화 40%** 비율 유지
6. **이모지 절대 사용 금지**
7. **기술 용어 사용 금지**
8. **제안하는 입장 유지**: 단정/명령이 아닌 제안 톤

2,000-2,500자 분량으로 존중과 정중함을 담아 작성해주세요:`;

    console.log('[프롬프트]', prompt);
    console.log('[프롬프트 길이]', prompt.length);

    // Claude API 호출
    const result = streamText({
      model: anthropic('claude-sonnet-4-5'),
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.7,
      maxOutputTokens: 4000,
    });

    // 스트리밍 응답 생성
    const stream = result.textStream;
    const encoder = new TextEncoder();

    const readableStream = new ReadableStream({
      async start(controller) {
        try {
          let chunkIndex = 0;
          let totalChars = 0;
          
          for await (const chunk of stream) {
            totalChars += chunk.length;
            chunkIndex++;
            
            if (chunkIndex === 1) {
              console.log('[첫 번째 청크]', chunk.substring(0, 50));
            }
            
            const data = '0:' + JSON.stringify(chunk) + '\n';
            controller.enqueue(encoder.encode(data));
          }
          
          console.log('[완료]', { chunks: chunkIndex, chars: totalChars });
          controller.close();
        } catch (error) {
          console.error('[스트림 오류]', error);
          controller.error(error);
        }
      },
    });

    return new Response(readableStream, {
      headers: {
        'Content-Type': 'text/plain; charset=utf-8',
        'Transfer-Encoding': 'chunked',
      },
    });
  } catch (error) {
    console.error('[API 오류]', error);
    
    return new Response(
      JSON.stringify({
        error: '제안서 생성 실패',
        details: error instanceof Error ? error.message : 'Unknown',
      }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' },
      }
    );
  }
}
